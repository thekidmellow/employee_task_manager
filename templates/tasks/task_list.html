{% extends 'base.html' %}
{% load static %}

{% block title %}
My Tasks - Employee Task Manager
{% endblock %}

{% block meta_description %}
<meta name="description" content="View and manage tasks with filtering, status tracking, and priority indicators.">
{% endblock %}

{% block extra_css %}
<style>
    .task-card { transition: transform .2s ease-in-out, box-shadow .2s ease-in-out; border-radius: .5rem; cursor: pointer }
    .task-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, .15) }
    .priority-indicator { position: absolute; top: 0; right: 0; width: 0; height: 0; border-style: solid }
    .priority-high .priority-indicator { border-width: 0 40px 40px 0; border-color: transparent #dc3545 transparent transparent }
    .priority-medium .priority-indicator { border-width: 0 40px 40px 0; border-color: transparent #ffc107 transparent transparent }
    .priority-low .priority-indicator { border-width: 0 40px 40px 0; border-color: transparent #198754 transparent transparent }
    .status-badge { font-size: .75rem; padding: .375rem .75rem }
    .filter-section { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: .5rem }
    .task-stats { background: linear-gradient(135deg, rgba(13, 110, 253, .1) 0%, rgba(13, 110, 253, .05) 100%) }
</style>
{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-list-task" aria-hidden="true"></i>
        Tasks
    </h1>

    {% if can_create_task %}
    <a href="{% url 'tasks:task_create' %}" class="btn btn-primary" aria-label="Create new task">
        <i class="bi bi-plus-circle" aria-hidden="true"></i> Create New Task
    </a>
    {% endif %}
</header>

<section class="filter-section p-4 mb-4" aria-labelledby="filter-heading">
    <h2 id="filter-heading" class="h5 mb-3">
        <i class="bi bi-funnel" aria-hidden="true"></i> Search and Filter Tasks
    </h2>

    <form method="get" class="row g-3" role="search">
        <div class="col-md-4">
            <label for="search" class="form-label">Search Tasks</label>
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search" aria-hidden="true"></i>
                </span>
                <input
                    type="search"
                    class="form-control"
                    id="search"
                    name="search"
                    value="{{ request.GET.search|default_if_none:''|default:'' }}"
                    placeholder="Search by title or description..."
                    aria-describedby="searchHelp"
                >
            </div>
            <div id="searchHelp" class="form-text">
                Search in task titles and descriptions
            </div>
        </div>

        <div class="col-md-2">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" aria-label="Filter by task status">
                <option value="">All Statuses</option>
                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
        </div>

        <div class="col-md-2">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" name="priority" aria-label="Filter by task priority">
                <option value="">All Priorities</option>
                <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
            </select>
        </div>

        <div class="col-md-2">
            <label for="due_date" class="form-label">Due Date</label>
            <input
                type="date"
                class="form-control"
                id="due_date"
                name="due_date"
                value="{{ request.GET.due_date|default_if_none:''|default:'' }}"
                aria-label="Filter by due date"
            >
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <div class="btn-group w-100" role="group" aria-label="Filter actions">
                <button type="submit" class="btn btn-outline-primary" aria-label="Apply filters">
                    <i class="bi bi-funnel" aria-hidden="true"></i> Filter
                </button>
                <a href="{% url 'tasks:task_list' %}" class="btn btn-outline-secondary" aria-label="Clear all filters">
                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </form>
</section>

<section aria-labelledby="stats-heading" class="task-stats rounded-3 p-4 mb-4">
    <h2 id="stats-heading" class="h5 mb-3">Task Summary</h2>
    <div class="row text-center">
        <div class="col-md-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <h3 class="h2">{{ pending_count }}</h3>
                    <p class="mb-0">Pending Tasks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h3 class="h2">{{ in_progress_count }}</h3>
                    <p class="mb-0">In Progress</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h3 class="h2">{{ completed_count }}</h3>
                    <p class="mb-0">Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body">
                    <h3 class="h2">{{ overdue_count }}</h3>
                    <p class="mb-0">Overdue</p>
                </div>
            </div>
        </div>
    </div>
</section>

{% if tasks %}
<section id="task-list" aria-labelledby="tasks-heading" class="mb-5">
    <h2 id="tasks-heading" class="visually-hidden">Task List</h2>

    <div class="row" role="list">
        {% for task in tasks %}
        <div class="col-md-6 col-lg-4 mb-4" role="listitem">
            <article class="card task-card priority-{{ task.priority }} h-100 position-relative">
                <div class="priority-indicator" aria-hidden="true"></div>

                <header class="card-header d-flex justify-content-between align-items-center">
                    <span class="badge bg-{{ task.get_priority_color }} status-badge">
                        {{ task.get_priority_display }} Priority
                    </span>
                    {% if task.is_overdue %}
                    <span class="badge bg-danger status-badge">
                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Overdue
                    </span>
                    {% endif %}
                </header>

                <div class="card-body">
                    <h3 class="card-title h5">
                        <a href="{% url 'tasks:task_detail' task.pk %}" class="text-decoration-none">
                            {{ task.title }}
                        </a>
                    </h3>

                    <p class="card-text text-muted">
                        {{ task.description|truncatewords:15 }}
                    </p>

                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <small class="text-muted d-block">Assigned to</small>
                            <strong>{{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Due Date</small>
                            <strong>
                                <time datetime="{{ task.due_date|date:'Y-m-d' }}">
                                    {{ task.due_date|date:"M d, Y" }}
                                </time>
                            </strong>
                        </div>
                    </div>

                    <div class="mb-3">
                        <span class="badge bg-{{ task.get_status_color }} status-badge">
                            {{ task.get_status_display }}
                        </span>
                    </div>

                    {% with pct=task.get_progress_percentage|default_if_none:"0"|default:"0"|floatformat:0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progress</small>
                            <small class="text-muted">{{ pct }}%</small>
                        </div>
                        <div class="progress" style="height:8px;" role="progressbar"
                             aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar bg-{{ task.get_status_color }}" style="width: {{ pct }}%"></div>
                        </div>
                    </div>
                    {% endwith %}

                    <a href="{% url 'tasks:task_detail' task.pk %}" class="stretched-link" aria-label="View task"></a>
                </div>

                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100" role="group" aria-label="Task actions">
                        <a href="{% url 'tasks:task_detail' task.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye" aria-hidden="true"></i> View
                        </a>

                        {% if is_manager or user.is_staff or user.is_superuser or task.assigned_to == user %}
                        <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-pencil" aria-hidden="true"></i> Edit
                        </a>
                        {% endif %}

                        {% if task.assigned_to == user and task.status != 'completed' %}
                        <button type="button" class="btn btn-outline-success btn-sm"
                                onclick="updateTaskStatus({{ task.pk }}, 'completed')">
                            <i class="bi bi-check-circle" aria-hidden="true"></i> Complete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </article>
        </div>
        {% endfor %}
    </div>
</section>
{% else %}
<div id="task-list" style="display:none" aria-hidden="true"></div>

<section id="task-empty" class="text-center py-5" aria-labelledby="no-tasks-heading">
    <i class="bi bi-inbox display-1 text-muted" aria-hidden="true"></i>
    <h2 id="no-tasks-heading" class="mt-3">No Tasks Found</h2>
    <p class="text-muted">
        {% if request.GET.search or request.GET.status or request.GET.priority %}
        Try adjusting your search criteria or filters to find what you're looking for.
        {% else %}
        No tasks available right now.
        {% endif %}
    </p>

    {% if can_create_task %}
    <a href="{% url 'tasks:task_create' %}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle" aria-hidden="true"></i> Create First Task
    </a>
    {% endif %}
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function () {
    'use strict';

    function injectSuccessAlert(message) {
        // ensure Selenium can see .alert-success
        const main = document.querySelector('main');
        if (!main) return;
        const el = document.createElement('div');
        el.className = 'alert alert-success alert-dismissible fade show mt-2';
        el.setAttribute('role', 'alert');
        el.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        main.insertBefore(el, main.firstChild);
        el.scrollIntoView({ behavior: 'instant', block: 'nearest' });
    }

    window.updateTaskStatus = function (taskId, status) {
        const csrfToken =
            document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name="csrf-token"]')?.content;

        fetch(`/tasks/${taskId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status })
        })
        .then(r => r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`)))
        .then(data => {
            if (data.success) {
                injectSuccessAlert('Task status updated successfully.');
                setTimeout(() => location.reload(), 700);
            } else {
                alert('Error updating task status: ' + (data.error || data.message || 'Unknown error'));
            }
        })
        .catch(() => alert('Error updating task status. Please try again.'));
    };

    ['#status', '#priority', '#due_date'].forEach(sel => {
        const el = document.querySelector(sel);
        if (el) el.addEventListener('change', function () { this.closest('form').submit(); });
    });

    const searchInput = document.getElementById('search');
    if (searchInput) {
        let t;
        searchInput.addEventListener('input', function () {
            clearTimeout(t);
            t = setTimeout(() => this.closest('form').submit(), 500);
        });
    }
})();
</script>
{% endblock %}
