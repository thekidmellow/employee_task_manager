{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ task.title }} - Employee Task Manager
{% endblock %}

{% block meta_description %}
<meta name="description"
    content="View detailed information for task: {{ task.title }}. Track progress, manage status updates, and collaborate with team members on task completion.">
{% endblock %}

{% block content %}
<header class="task-header priority-{{ task.priority }} p-4 mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">{{ task.title }}</h1>

            <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
                <span class="badge bg-{{ task.get_priority_badge_color }} badge-custom">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                    {{ task.get_priority_display }} Priority
                </span>

                <span class="badge bg-secondary badge-custom status-transition">
                    <i class="bi bi-flag" aria-hidden="true"></i>
                    <span id="status-label">{{ task.get_status_display }}</span>
                </span>

                <form method="post" class="d-inline ms-3" id="statusForm" onsubmit="return false;">
                    {% csrf_token %}
                    <select name="status" id="status-select" class="form-select form-select-sm w-auto d-inline-block"
                        aria-label="Update task status">
                        {% for value, label in task.STATUS_CHOICES %}
                        <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <p class="text-muted mb-0">
                Created by {{ task.created_by.username }}
                on <time datetime="{{ task.created_at|date:'Y-m-d' }}">{{ task.created_at|date:"F j, Y" }}</time>
            </p>
        </div>

        <div class="col-md-4 text-md-end">
            <div class="btn-group" role="group" aria-label="Task actions">
                <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-outline-primary"
                    aria-label="Edit task details">
                    <i class="bi bi-pencil" aria-hidden="true"></i> Edit
                </a>

                <button type="button" class="btn btn-danger" onclick="deleteTask({{ task.pk }})"
                    aria-label="Delete task">
                    <i class="bi bi-trash" aria-hidden="true"></i> Delete
                </button>
            </div>
        </div>
    </div>
</header>

<div class="row">
    <div class="col-lg-8">
        <section class="card mb-4">
            <header class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-info-circle" aria-hidden="true"></i> Task Details
                </h2>
            </header>

            <div class="card-body">
                <div class="detail-row">
                    <div class="row">
                        <div class="col-sm-3"><strong>Description:</strong></div>
                        <div class="col-sm-9">
                            <div class="text-break">
                                {{ task.description|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="row">
                        <div class="col-sm-3"><strong>Assigned To:</strong></div>
                        <div class="col-sm-9">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle me-2 text-primary" aria-hidden="true"></i>
                                <div>
                                    <div class="fw-semibold">
                                        {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                    </div>
                                    <small class="text-muted">Employee</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="row">
                        <div class="col-sm-3"><strong>Created By:</strong></div>
                        <div class="col-sm-9">
                            <i class="bi bi-person-plus me-1 text-secondary" aria-hidden="true"></i>
                            {{ task.created_by.get_full_name|default:task.created_by.username }}
                            <span class="badge bg-secondary ms-2">Manager</span>
                        </div>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="row">
                        <div class="col-sm-3"><strong>Due Date:</strong></div>
                        <div class="col-sm-9">
                            <i class="bi bi-calendar-event me-1 text-primary" aria-hidden="true"></i>
                            {% if task.due_date %}
                            <time datetime="{{ task.due_date|date:'Y-m-d' }}">
                                {{ task.due_date|date:"l, F j, Y" }}
                            </time>
                            {% else %}
                            <span class="text-muted">No due date set</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <header class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-chat-dots" aria-hidden="true"></i>
                    Comments & Updates
                    <span class="badge bg-secondary ms-2">{{ comments.count }}</span>
                </h2>
            </header>

            <div class="card-body">
                <form method="post" class="mb-4" id="commentForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="comment" class="form-label">
                            <i class="bi bi-chat-square-text" aria-hidden="true"></i> Add a comment or update:
                        </label>
                        <textarea class="form-control" id="comment" name="comment" rows="4"
                            placeholder="Share progress updates, ask questions, or provide feedback..." required
                            aria-describedby="commentHelp"></textarea>
                        <div id="commentHelp" class="form-text">
                            Use this space to communicate progress, ask questions, or share important updates about this
                            task.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="commentSubmitBtn">
                        <i class="bi bi-send" aria-hidden="true"></i> Post Comment
                    </button>
                </form>

                {% if comments %}
                <div class="list-group">
                    {% for comment in comments %}
                    <article class="list-group-item comment-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ comment.user.get_full_name|default:comment.user.username }}</strong>
                                <div class="text-muted small">
                                    <time datetime="{{ comment.created_at|date:'Y-m-d' }}">
                                        {{ comment.created_at|date:"M d, Y H:i" }}
                                    </time>
                                </div>
                            </div>
                        </div>

                        <p class="mb-0 mt-2 text-break">
                            {{ comment.comment|linebreaksbr }}
                        </p>
                    </article>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-chat display-4" aria-hidden="true"></i>
                    <h3 class="mt-3 h5">No comments yet</h3>
                    <p class="mb-0">Be the first to add an update or comment on this task!</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <aside class="col-lg-4">
        <section class="card mb-4">
            <header class="card-header">
                <h2 class="h5 mb-0"><i class="bi bi-clock-history" aria-hidden="true"></i> Timeline</h2>
            </header>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Task Created</strong>
                        <div class="text-muted small">
                            <time datetime="{{ task.created_at|date:'Y-m-d' }}">
                                {{ task.created_at|date:"M d, Y \\a\\t H:i" }}
                            </time>
                            <div>by {{ task.created_by.get_full_name|default:task.created_by.username }}</div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <strong>Last Updated</strong>
                        <div class="text-muted small">
                            <time datetime="{{ task.updated_at|date:'Y-m-d' }}">
                                {{ task.updated_at|date:"M d, Y \\a\\t H:i" }}
                            </time>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <header class="card-header">
                <h2 class="h5 mb-0">Navigation</h2>
            </header>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'tasks:task_list' %}" class="btn btn-outline-primary"
                        aria-label="Return to task list">
                        <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Tasks
                    </a>

                    <a href="/dashboard/" class="btn btn-outline-secondary" aria-label="Go to dashboard">
                        <i class="bi bi-speedometer2" aria-hidden="true"></i> Dashboard
                    </a>
                </div>
            </div>
        </section>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        'use strict';

        function showAlert(message, type) {
            document.querySelectorAll('.alert-auto').forEach(a => a.remove());
            const el = document.createElement('div');
            el.className = `alert alert-${type} alert-dismissible fade show alert-auto`;
            el.setAttribute('role', 'alert');
            el.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
            const main = document.getElementById('main-content') || document.querySelector('main');
            if (main) {
                main.insertBefore(el, main.firstChild);
            }
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                document.querySelector('meta[name="csrf-token"]')?.content;
        }

        const statusSelect = document.getElementById('status-select');
        if (statusSelect) {
            statusSelect.addEventListener('change', function () {
                const csrfToken = getCsrfToken();
                const newStatus = this.value;

                fetch("{% url 'tasks:update_task_status' task.pk %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ status: newStatus })
                })
                    .then(r => r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`)))
                    .then(data => {
                        if (!data.success) throw new Error(data.error || data.message || 'Unknown error');
                        const label = document.getElementById('status-label');
                        if (label) label.textContent = newStatus.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        showAlert('Status updated successfully.', 'success');
                    })
                    .catch(() => showAlert('Error updating status. Please try again.', 'danger'));
            });
        }

        window.deleteTask = function () {
            if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) return;

            const csrfToken = getCsrfToken();

            fetch("{% url 'tasks:task_delete' task.pk %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
                .then(r => {
                    if (!r.ok) throw new Error('Delete failed');
                    showAlert('Task deleted successfully.', 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'tasks:task_list' %}";
                    }, 800);
                })
                .catch(() => showAlert('Error deleting task.', 'danger'));
        };
    })();
</script>
{% endblock %}